{"version":3,"file":"react-async-component.js","sources":["../src/createAsyncContext.js","../src/AsyncComponentProvider.js","../src/asyncComponent.js"],"sourcesContent":["export default () => {\n  let idPointer = 0\n  const registry = {}\n  const errors = {}\n  return {\n    getNextId: () => {\n      idPointer += 1\n      return idPointer\n    },\n    resolved(id) {\n      registry[id] = true\n    },\n    failed(id, error) {\n      errors[id] = error\n    },\n    getState() {\n      return {\n        resolved: Object.keys(registry).reduce(\n          (acc, cur) => Object.assign(acc, { [cur]: true }),\n          {},\n        ),\n        errors,\n      }\n    },\n  }\n}\n","import React, { Component } from 'react'\nimport PropTypes from 'prop-types'\n\nimport createAsyncContext from './createAsyncContext'\n\nexport default class AsyncComponentProvider extends Component {\n  static propTypes = {\n    children: PropTypes.node.isRequired,\n    asyncContext: PropTypes.shape({\n      getNextId: PropTypes.func.isRequired,\n      resolved: PropTypes.func.isRequired,\n      failed: PropTypes.func.isRequired,\n      getState: PropTypes.func.isRequired,\n    }),\n    rehydrateState: PropTypes.shape({\n      resolved: PropTypes.object,\n    }),\n  }\n\n  static defaultProps = {\n    asyncContext: undefined,\n    rehydrateState: {\n      resolved: {},\n    },\n  }\n\n  static childContextTypes = {\n    asyncComponents: PropTypes.shape({\n      getNextId: PropTypes.func.isRequired,\n      resolved: PropTypes.func.isRequired,\n      failed: PropTypes.func.isRequired,\n      shouldRehydrate: PropTypes.func.isRequired,\n      getError: PropTypes.func.isRequired,\n    }).isRequired,\n  }\n\n  componentWillMount() {\n    this.asyncContext = this.props.asyncContext || createAsyncContext()\n    this.rehydrateState = this.props.rehydrateState\n  }\n\n  getChildContext() {\n    return {\n      asyncComponents: {\n        getNextId: this.asyncContext.getNextId,\n        resolved: this.asyncContext.resolved,\n        failed: this.asyncContext.failed,\n        shouldRehydrate: id => {\n          const resolved = this.rehydrateState.resolved[id]\n          delete this.rehydrateState.resolved[id]\n          return resolved\n        },\n        getError: id =>\n          this.rehydrateState.errors && this.rehydrateState.errors[id],\n      },\n    }\n  }\n\n  render() {\n    return React.Children.only(this.props.children)\n  }\n}\n","import React from 'react'\nimport PropTypes from 'prop-types'\n\nconst validSSRModes = ['resolve', 'defer', 'boundary']\n\nexport default function asyncComponent(config) {\n  const {\n    name,\n    resolve,\n    autoResolveES2015Default = true,\n    serverMode = 'resolve',\n    LoadingComponent,\n    ErrorComponent,\n  } = config\n\n  if (validSSRModes.indexOf(serverMode) === -1) {\n    throw new Error('Invalid serverMode provided to asyncComponent')\n  }\n\n  const env =\n    ['node', 'browser'].indexOf(config.env) > -1\n      ? config.env\n      : typeof window === 'undefined' ? 'node' : 'browser'\n\n  const state = {\n    // A unique id we will assign to our async component which is especially\n    // useful when rehydrating server side rendered async components.\n    id: null,\n    // This will be use to hold the resolved module allowing sharing across\n    // instances.\n    // NOTE: When using React Hot Loader this reference will become null.\n    module: null,\n    // If an error occurred during a resolution it will be stored here.\n    error: null,\n    // Allows us to share the resolver promise across instances.\n    resolver: null,\n    // Indicates whether resolving is taking place\n    resolving: false,\n    // Handle on the contexts so we don't lose it during async resolution\n    asyncComponents: null,\n    asyncComponentsAncestor: null,\n  }\n\n  const needToResolveOnBrowser = () =>\n    state.module == null &&\n    state.error == null &&\n    !state.resolving &&\n    typeof window !== 'undefined'\n\n  // Takes the given module and if it has a \".default\" the \".default\" will\n  // be returned. i.e. handy when you could be dealing with es6 imports.\n  const es6Resolve = x =>\n    autoResolveES2015Default &&\n    x != null &&\n    (typeof x === 'function' || typeof x === 'object') &&\n    x.default\n      ? x.default\n      : x\n\n  const getResolver = () => {\n    if (state.resolver == null) {\n      state.resolving = true\n      try {\n        state.resolver = Promise.resolve(resolve())\n      } catch (err) {\n        state.resolver = Promise.reject(err)\n      }\n    }\n    return state.resolver\n  }\n\n  return class AsyncComponent extends React.Component {\n    static displayName = name || 'AsyncComponent'\n\n    static contextTypes = {\n      asyncComponentsAncestor: PropTypes.shape({\n        isBoundary: PropTypes.bool,\n      }),\n      asyncComponents: PropTypes.shape({\n        getNextId: PropTypes.func.isRequired,\n        resolved: PropTypes.func.isRequired,\n        shouldRehydrate: PropTypes.func.isRequired,\n      }),\n    }\n\n    static childContextTypes = {\n      asyncComponentsAncestor: PropTypes.shape({\n        isBoundary: PropTypes.bool,\n      }),\n    }\n\n    getChildContext() {\n      return {\n        asyncComponentsAncestor:\n          state.asyncComponents == null\n            ? null\n            : {\n                isBoundary: serverMode === 'boundary',\n              },\n      }\n    }\n\n    componentWillMount() {\n      if (this.context.asyncComponents != null) {\n        state.asyncComponents = this.context.asyncComponents\n        state.asyncComponentsAncestor = this.context.asyncComponentsAncestor\n        if (!state.id) {\n          state.id = this.context.asyncComponents.getNextId()\n        }\n      }\n    }\n\n    // react-async-bootstrapper\n    bootstrap() {\n      const doResolve = () =>\n        this.resolveModule().then(\n          module => (module === undefined ? false : undefined),\n        )\n\n      // browser\n      if (env === 'browser') {\n        const { shouldRehydrate, getError } = state.asyncComponents\n        const error = getError(state.id)\n        if (error) {\n          state.error = error\n          return false\n        }\n        return shouldRehydrate(state.id) ? doResolve() : false\n      }\n\n      // node\n      const isChildOfBoundary =\n        state.asyncComponentsAncestor != null &&\n        state.asyncComponentsAncestor.isBoundary\n\n      return serverMode === 'defer' || isChildOfBoundary ? false : doResolve()\n    }\n\n    componentDidMount() {\n      if (needToResolveOnBrowser()) {\n        this.resolveModule()\n      }\n    }\n\n    resolveModule() {\n      return getResolver()\n        .then(module => {\n          if (state.asyncComponents != null) {\n            state.asyncComponents.resolved(state.id)\n          }\n          state.module = module\n          state.error = null\n          state.resolving = false\n          return module\n        })\n        .catch(({ message, stack }) => {\n          const error = { message, stack }\n          if (state.asyncComponents != null) {\n            state.asyncComponents.failed(state.id, error)\n          }\n          state.error = error\n          state.resolving = false\n          if (!ErrorComponent) {\n            // eslint-disable-next-line no-console\n            console.error(error)\n          }\n        })\n        .then(result => {\n          if (this.unmounted) {\n            return undefined\n          }\n          if (\n            !this.context.reactAsyncBootstrapperRunning &&\n            env === 'browser'\n          ) {\n            this.forceUpdate()\n          }\n          return result\n        })\n    }\n\n    componentWillUnmount() {\n      this.unmounted = true\n    }\n\n    render() {\n      const { module, error } = state\n\n      if (error) {\n        return ErrorComponent ? (\n          <ErrorComponent {...this.props} error={error} />\n        ) : null\n      }\n\n      const Component = es6Resolve(module)\n      return Component ? (\n        <Component {...this.props} />\n      ) : LoadingComponent ? (\n        <LoadingComponent {...this.props} />\n      ) : null\n    }\n  }\n}\n"],"names":["idPointer","registry","errors","id","error","Object","keys","reduce","acc","cur","assign","AsyncComponentProvider","asyncContext","props","createAsyncContext","rehydrateState","getNextId","resolved","failed","React","Children","only","children","Component","propTypes","PropTypes","node","isRequired","shape","func","object","defaultProps","undefined","childContextTypes","validSSRModes","asyncComponent","config","name","resolve","autoResolveES2015Default","serverMode","LoadingComponent","ErrorComponent","indexOf","Error","env","window","state","needToResolveOnBrowser","module","resolving","es6Resolve","x","default","getResolver","resolver","Promise","err","reject","asyncComponents","context","asyncComponentsAncestor","doResolve","resolveModule","then","shouldRehydrate","getError","isChildOfBoundary","isBoundary","catch","message","stack","unmounted","reactAsyncBootstrapperRunning","forceUpdate","result","displayName","contextTypes","bool"],"mappings":"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"}